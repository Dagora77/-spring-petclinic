#!groovy

pipeline {
    agent any
    options {
        ansiColor('xterm')
    }    
    stages {
        stage('Captcha') {
            steps {
                script {
                    if (env.CAPTCHA == 'ConfirmOperation') {
                        echo "Captcha confirmed, go on..."
                    } else {
                        error "Captcha FAILED!!!"
                        return
                    }
                }
            }
        }
        stage("Docker run") {
            steps {
                echo "Run docker container"
                script {
                    if (env.build_env == 'qa_mypetclinic') {
                        sshagent(['mypetclinic_server']) {
                        sh "ssh -o StrictHostKeyChecking=no ec2-user@10.0.10.57 docker rm -f qa_mypetclinic || true "
                        sh "ssh -o StrictHostKeyChecking=no ec2-user@10.0.10.57 docker run --name qa_mypetclinic --rm -d -p 8080:8080 10.0.11.150:5000/${DOCKER_IMAGE}"
                        }
                    
                    } else if (env.build_env == 'staging_mypetclinic') {
                        sshagent(['prod-qa-env']) {
                        sh "ssh -o StrictHostKeyChecking=no ec2-user@172.31.91.163 ${dockerRun}"
                        }
                        
                    } else if (env.build_env == 'prod_mypetclinic') {
                        sshagent(['prod-qa-env']) {
                        sh "ssh -o StrictHostKeyChecking=no ec2-user@172.31.91.163 ${dockerRun}"
                        }
                        
                    } else {
                        echo 'Something went wrong'
                    }
                }
                
            }
        }
        stage('Ensure that application is running'){
            steps{               
               script {
                    if (env.ENV_NAME == 'mypetclinic_qa_deploy') {
                        sh 'curl -I localhost:8080'
                    } else if (env.ENV_NAME == 'mypetclinic_staging_deploy') {
                        sh 'curl -I localhost:8082'
                    } else if (env.ENV_NAME == 'mypetclinic_prod_deploy') {
                        sh 'curl -I localhost:8081'
                    } else {
                        error "Applicatin isn't working..."
                        return
                    }
                }
            }
        }
    }
  }
